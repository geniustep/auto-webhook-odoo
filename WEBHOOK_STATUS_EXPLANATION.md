# ุดุฑุญ ุญุงูุงุช Webhook Events

## ๐ ุงูุญุงูุงุช ุงููุชุงุญุฉ (5 ุญุงูุงุช)

### 1. **Pending (ูุนูู)** โณ
**ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ ุนูุฏ ุงูุฅูุดุงุก**

- **ูุชู ุชุญุฏุซ:**
  - ุนูุฏ ุฅูุดุงุก webhook event ุฌุฏูุฏ (ุชููุงุฆูุงู ุนูุฏ create/write/unlink)
  - ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ ูุฌููุน ุงูุฃุญุฏุงุซ ุงูุฌุฏูุฏุฉ

- **ุงููุนูู:**
  - ุงูุญุฏุซ ูู ุงูุชุธุงุฑ ุงููุนุงูุฌุฉ
  - ูู ูุชู ุฅุฑุณุงูู ุจุนุฏ ุฅูู Subscriber
  - ุฌุงูุฒ ูููุนุงูุฌุฉ ูู ูุจู Cron Job

- **ูุซุงู:**
  ```
  Event ID: 151
  Status: pending
  Model: sale.order
  Record ID: 344
  Event: create
  ```

- **ุงูุงูุชูุงู ุงูุชุงูู:**
  - `pending` โ `processing` (ุนูุฏ ุจุฏุก ุงููุนุงูุฌุฉ)
  - `pending` โ `failed` (ุฅุฐุง ูู ููู ููุงู subscriber)

---

### 2. **Processing (ููุฏ ุงููุนุงูุฌุฉ)** ๐
**ุนูุฏ ุจุฏุก ุฅุฑุณุงู ุงูุญุฏุซ**

- **ูุชู ุชุญุฏุซ:**
  - ุนูุฏ ุจุฏุก ูุนุงูุฌุฉ ุงูุญุฏุซ ุจูุงุณุทุฉ `process_event()`
  - ูุจู ุฅุฑุณุงู HTTP request ุฅูู Subscriber
  - ุฃุซูุงุก ุงูุชุธุงุฑ ุงูุฑุฏ ูู Subscriber

- **ุงููุนูู:**
  - ุงูุญุฏุซ ููุฏ ุงูุฅุฑุณุงู ุญุงููุงู
  - ุชู ุจุฏุก HTTP request
  - ูู ุงูุชุธุงุฑ ุงูุฑุฏ ูู endpoint

- **ูุซุงู:**
  ```
  Event ID: 151
  Status: processing
  Subscriber: BridgeCore Default Endpoint
  URL: https://api.bridgecore.ma/webhook
  ```

- **ุงูุงูุชูุงู ุงูุชุงูู:**
  - `processing` โ `sent` (ุฅุฐุง ูุฌุญ ุงูุฅุฑุณุงู)
  - `processing` โ `failed` (ุฅุฐุง ูุดู ุงูุฅุฑุณุงู)

---

### 3. **Sent (ุชู ุงูุฅุฑุณุงู)** โ
**ุนูุฏ ูุฌุงุญ ุงูุฅุฑุณุงู**

- **ูุชู ุชุญุฏุซ:**
  - ุจุนุฏ ูุฌุงุญ ุฅุฑุณุงู HTTP request
  - ุนูุฏ ุงุณุชูุงู response code 200-299 ูู Subscriber
  - ุจุนุฏ ุญูุธ ูุนูููุงุช ุงูุฑุฏ (response_code, response_body)

- **ุงููุนูู:**
  - ุชู ุฅุฑุณุงู ุงูุญุฏุซ ุจูุฌุงุญ
  - Subscriber ุงุณุชูู ุงูุจูุงูุงุช
  - ุงูุญุฏุซ ููุชูู ููุง ูุญุชุงุฌ ุฅุนุงุฏุฉ ูุญุงููุฉ

- **ูุนูููุงุช ุฅุถุงููุฉ:**
  - `sent_at`: ููุช ุงูุฅุฑุณุงู ุงููุงุฌุญ
  - `response_code`: HTTP status code (ูุซูุงู: 200, 201)
  - `response_body`: ูุญุชูู ุงูุฑุฏ ูู Subscriber
  - `processing_time`: ููุช ุงููุนุงูุฌุฉ ุจุงููููู ุซุงููุฉ

- **ูุซุงู:**
  ```
  Event ID: 151
  Status: sent
  Sent At: 2025-11-16 20:43:48
  Response Code: 200
  Processing Time: 125.5 ms
  ```

- **ุงูุงูุชูุงู ุงูุชุงูู:**
  - `sent` โ (ูุง ููุฌุฏ - ุงูุญุงูุฉ ุงูููุงุฆูุฉ ูููุฌุงุญ)

---

### 4. **Failed (ูุงุดู)** โ
**ุนูุฏ ูุดู ุงูุฅุฑุณุงู**

- **ูุชู ุชุญุฏุซ:**
  - ุนูุฏ ูุดู HTTP request (timeout, connection error)
  - ุนูุฏ ุงุณุชูุงู error code (400-599)
  - ุนูุฏ ุนุฏู ูุฌูุฏ subscriber
  - ุนูุฏ ุญุฏูุซ exception ุฃุซูุงุก ุงููุนุงูุฌุฉ

- **ุงููุนูู:**
  - ูุดู ุฅุฑุณุงู ุงูุญุฏุซ
  - ุณูุชู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุชููุงุฆูุงู
  - ุงูุญุฏุซ ูุงุจู ููุฅุนุงุฏุฉ (retry)

- **ูุนูููุงุช ุฅุถุงููุฉ:**
  - `error_message`: ุฑุณุงูุฉ ุงูุฎุทุฃ
  - `error_type`: ููุน ุงูุฎุทุฃ (timeout, connection, validation, etc.)
  - `error_code`: HTTP error code (ูุซูุงู: 404, 500)
  - `retry_count`: ุนุฏุฏ ุงููุญุงููุงุช ุงูุณุงุจูุฉ
  - `next_retry_at`: ููุช ุงููุญุงููุฉ ุงููุงุฏูุฉ

- **Retry Mechanism (ุขููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ):**
  - **Exponential Backoff**: ุฒูุงุฏุฉ ุงูููุช ุจูู ุงููุญุงููุงุช
  - ุงููุญุงููุฉ 1: ุจุนุฏ 60 ุซุงููุฉ
  - ุงููุญุงููุฉ 2: ุจุนุฏ 120 ุซุงููุฉ (2 ุฏูููุฉ)
  - ุงููุญุงููุฉ 3: ุจุนุฏ 240 ุซุงููุฉ (4 ุฏูุงุฆู)
  - ุงููุญุงููุฉ 4: ุจุนุฏ 480 ุซุงููุฉ (8 ุฏูุงุฆู)
  - ุงููุญุงููุฉ 5: ุจุนุฏ 960 ุซุงููุฉ (16 ุฏูููุฉ)

- **ูุซุงู:**
  ```
  Event ID: 22
  Status: failed
  Error: No subscriber configured for this event
  Retry Count: 0
  Next Retry At: 2025-11-16 20:44:48
  ```

- **ุงูุงูุชูุงู ุงูุชุงูู:**
  - `failed` โ `processing` (ุนูุฏ ุฅุนุงุฏุฉ ุงููุญุงููุฉ)
  - `failed` โ `dead` (ุฅุฐุง ุชุฌุงูุฒุช ุงููุญุงููุงุช max_retries)

---

### 5. **Dead Letter (ูุงุฆูุฉ ุงูููุชู)** ๐
**ุนูุฏ ูุดู ุฌููุน ุงููุญุงููุงุช**

- **ูุชู ุชุญุฏุซ:**
  - ุจุนุฏ ุชุฌุงูุฒ `max_retries` (ุงูุงูุชุฑุงุถู: 5 ูุญุงููุงุช)
  - ุนูุฏูุง ููุดู ุงูุญุฏุซ ุจุดูู ุฏุงุฆู
  - ุนูุฏ ููู ุงูุญุฏุซ ุฅูู Dead Letter Queue

- **ุงููุนูู:**
  - ุงูุญุฏุซ ูุดู ุจุดูู ุฏุงุฆู
  - ูุง ูููู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุชููุงุฆูุงู
  - ูุญุชุงุฌ ุชุฏุฎู ูุฏูู ูููุนุงูุฌุฉ

- **ูุนูููุงุช ุฅุถุงููุฉ:**
  - `error_message`: ุขุฎุฑ ุฑุณุงูุฉ ุฎุทุฃ
  - `error_type`: max_retries_exceeded
  - `retry_count`: ุนุฏุฏ ุงููุญุงููุงุช ุงูููู
  - ูุชู ุฅูุดุงุก ุณุฌู ูู `webhook.retry` (Dead Letter Queue)

- **ูุซุงู:**
  ```
  Event ID: 100
  Status: dead
  Error: Connection timeout after 5 retries
  Retry Count: 5
  Max Retries: 5
  ```

- **ุงูุงูุชูุงู ุงูุชุงูู:**
  - `dead` โ (ูุง ููุฌุฏ - ุงูุญุงูุฉ ุงูููุงุฆูุฉ ูููุดู)
  - ูููู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุฏููุงู ูู Dead Letter Queue

---

## ๐ ุฏูุฑุฉ ุญูุงุฉ Webhook Event

```
1. Create/Write/Unlink ูู Odoo
   โ
2. PENDING (ุฅูุดุงุก event ุฌุฏูุฏ)
   โ
3. PROCESSING (ุจุฏุก ุงูุฅุฑุณุงู)
   โ
4a. SENT (ูุฌุญ) โ
   OR
4b. FAILED (ูุดู) โ
   โ
5. Retry (ุฅุนุงุฏุฉ ูุญุงููุฉ)
   โ
6a. SENT (ูุฌุญ ุจุนุฏ retry) โ
   OR
6b. FAILED (ูุดู ูุฑุฉ ุฃุฎุฑู) โ
   โ
7. Repeat retry ุญุชู max_retries
   โ
8a. SENT (ูุฌุญ) โ
   OR
8b. DEAD (ูุดู ููุงุฆู) ๐
```

---

## ๐ ุฅุญุตุงุฆูุงุช ุงูุญุงูุงุช

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช `done`:
- **Pending**: ุงูุฃุญุฏุงุซ ุงูุฌุฏูุฏุฉ ูู ุงูุชุธุงุฑ ุงููุนุงูุฌุฉ
- **Sent**: ุงูุฃุญุฏุงุซ ุงูุชู ุชู ุฅุฑุณุงููุง ุจูุฌุงุญ
- **Failed**: ุงูุฃุญุฏุงุซ ุงูุชู ูุดูุช (ูุงุจูุฉ ููุฅุนุงุฏุฉ)
- **Dead**: ุงูุฃุญุฏุงุซ ุงูุชู ูุดูุช ููุงุฆูุงู

---

## ๐ ููููุฉ ุงูุชุญูู ูู ุงูุญุงูุงุช

### ูู ูุงุฌูุฉ Odoo:
1. ุงุฐูุจ ุฅูู: **Webhooks โ Dashboard**
2. ุงุณุชุฎุฏู ุงูููุงุชุฑ:
   - **Pending Events**: `status = 'pending'`
   - **Failed Events**: `status = 'failed'`
   - **Sent Events**: `status = 'sent'`
   - **Dead Letter**: `status = 'dead'`

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```sql
-- ุฌููุน ุงูุฃุญุฏุงุซ ุญุณุจ ุงูุญุงูุฉ
SELECT status, COUNT(*) as total
FROM webhook_event
GROUP BY status;

-- ุงูุฃุญุฏุงุซ ุงููุนููุฉ
SELECT * FROM webhook_event
WHERE status = 'pending'
ORDER BY timestamp DESC;

-- ุงูุฃุญุฏุงุซ ุงููุงุดูุฉ ุงููุงุจูุฉ ููุฅุนุงุฏุฉ
SELECT * FROM webhook_event
WHERE status = 'failed'
AND retry_count < max_retries
ORDER BY next_retry_at ASC;
```

---

## โ๏ธ ุฅุนุฏุงุฏุงุช Retry

- **Max Retries**: ุงูุญุฏ ุงูุฃูุตู ูููุญุงููุงุช (ุงูุงูุชุฑุงุถู: 5)
- **Base Delay**: ุงูููุช ุงูุฃุณุงุณู ุจูู ุงููุญุงููุงุช (60 ุซุงููุฉ)
- **Exponential Backoff**: ูุถุงุนูุฉ ุงูููุช ูุน ูู ูุญุงููุฉ

---

## ๐ฏ ููุฎุต ุณุฑูุน

| ุงูุญุงูุฉ | ุงููุนูู | ูุงุจู ููุฅุนุงุฏุฉ | ุงูุญุงูุฉ ุงูููุงุฆูุฉ |
|--------|--------|--------------|-----------------|
| **Pending** | ูู ุงูุชุธุงุฑ ุงููุนุงูุฌุฉ | โ | โ |
| **Processing** | ููุฏ ุงูุฅุฑุณุงู | โ | โ |
| **Sent** | ุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ | โ | โ |
| **Failed** | ูุดู (ูุงุจู ููุฅุนุงุฏุฉ) | โ | โ |
| **Dead** | ูุดู ููุงุฆู | โ | โ |

---

## ๐ก ูุตุงุฆุญ

1. **ูุฑุงูุจุฉ Pending Events**: ุชุฃูุฏ ูู ุฃู Cron Job ูุนูู ุจุดูู ุตุญูุญ
2. **ูุญุต Failed Events**: ุฑุงุฌุน `error_message` ูููู ุณุจุจ ุงููุดู
3. **Dead Letter Queue**: ุฑุงุฌุน ุงูุฃุญุฏุงุซ ุงูููุชุฉ ุจุงูุชุธุงู ูููุนุงูุฌุฉ ุงููุฏููุฉ
4. **Response Codes**: ุชุญูู ูู `response_code` ูููู ุฑุฏ Subscriber

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2025-11-16

